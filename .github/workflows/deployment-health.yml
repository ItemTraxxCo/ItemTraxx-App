name: Deployment Health

permissions:
  contents: read

on:
  workflow_dispatch:
  schedule:
    - cron: "15 * * * *"

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Check site and security headers
        run: |
          set -euo pipefail
          BROWSER_UA="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36"
          CHALLENGE_SKIPS=0
          PASS_COUNT=0

          check_headers() {
            local url="$1"
            echo "== $url"
            local headers
            headers="$(curl -sSI --http1.1 \
              --retry 3 \
              --retry-delay 2 \
              --retry-all-errors \
              -A "$BROWSER_UA" \
              -H "Accept: text/html,application/xhtml+xml" \
              -H "Accept-Language: en-US,en;q=0.9" \
              "$url")"

            local status
            status="$(printf "%s\n" "$headers" | awk 'NR==1 {print $2}')"
            if [ -z "$status" ]; then
              echo "Missing HTTP status for $url"
              exit 1
            fi
            if [ "$status" -ge 400 ]; then
              if [ "$status" -eq 403 ] && printf "%s\n" "$headers" | grep -qi "cf-mitigated: challenge"; then
                echo "Cloudflare challenge for $url (non-browser CI request). Skipping this URL."
                CHALLENGE_SKIPS=$((CHALLENGE_SKIPS + 1))
                return 0
              fi
              echo "HTTP $status for $url"
              printf "%s\n" "$headers"
              return 1
            fi

            printf "%s\n" "$headers" | grep -i "content-security-policy" >/dev/null
            printf "%s\n" "$headers" | grep -i "strict-transport-security" >/dev/null
            PASS_COUNT=$((PASS_COUNT + 1))
          }

          FAILED=0
          for u in \
            "https://itemtraxx.com" \
            "https://www.itemtraxx.com" \
            "https://itemtraxx.com/login" \
            "https://itemtraxx.com/tenant/checkout"; do
            if ! check_headers "$u"; then
              FAILED=1
            fi
          done

          if [ "$FAILED" -ne 0 ]; then
            echo "One or more header checks failed."
            exit 1
          fi

          if [ "$PASS_COUNT" -eq 0 ]; then
            echo "All URL checks were Cloudflare-challenged; unable to validate headers from CI."
            exit 1
          fi

          echo "Header checks passed: $PASS_COUNT, challenge skips: $CHALLENGE_SKIPS"

      - name: Check status endpoint
        run: |
          set -euo pipefail
          curl -fsS "https://itemtraxx-edge-proxy.itemtraxx-co.workers.dev/functions/system-status" \
            -H "Origin: https://itemtraxx.com" \
            | head -c 300
