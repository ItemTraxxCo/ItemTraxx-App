name: Supabase Backup

permissions:
  contents: read

on:
  workflow_dispatch:
  schedule:
    - cron: "35 6,18 * * *"

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Docker availability
        run: |
          docker --version

      - name: Run encrypted daily backup
        env:
          SUPABASE_BACKUP_DATABASE_URL: ${{ secrets.SUPABASE_BACKUP_DATABASE_URL }}
          SUPABASE_BACKUP_DATABASE_URL_FALLBACK: ${{ secrets.SUPABASE_BACKUP_DATABASE_URL_FALLBACK }}
          SUPABASE_BACKUP_REPO: ${{ secrets.SUPABASE_BACKUP_REPO }}
          SUPABASE_BACKUP_REPO_TOKEN: ${{ secrets.SUPABASE_BACKUP_REPO_TOKEN }}
          SUPABASE_BACKUP_ENCRYPTION_PASSPHRASE: ${{ secrets.SUPABASE_BACKUP_ENCRYPTION_PASSPHRASE }}
          SUPABASE_BACKUP_REPO_BRANCH: ${{ secrets.SUPABASE_BACKUP_REPO_BRANCH }}
          SUPABASE_BACKUP_PREFIX: itemtraxx_prod
          SUPABASE_BACKUP_USE_DOCKER_PG_DUMP: "true"
          SUPABASE_BACKUP_PG_DUMP_TAG: "17"
          SUPABASE_BACKUP_RETENTION_DAYS: "365"
        run: ./scripts/github-supabase-backup.sh
